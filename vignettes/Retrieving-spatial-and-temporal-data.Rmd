---
title: "Retrieving spatial and temporal data"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Retrieving-spatial-and-temporal-data}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

### CEDEX time series

Time series of streamflow data from the basins of the most important Spanish rivers are available at the web site of the "Centro de Estudios Hidrográficos" (https://ceh.cedex.es/web/default.htm), which belongs to the "Centro de Estudios y Experimentación de Obras Públicas", an institution of the Spanish Government. Although below we will show how to obtain those datasets quickly with appropriate R functions, one can carry out many (though not all) of those tasks by hand by clicking on "Anuario aforos" on that web, then on "Acceso de Anuario de Aforos 2019-2020", next on "Descarga de Datos Organismo de Cuenca" and finally selecting a basin.

To load CEDEX datasets and preprocess those time series we have implemented the package $dendrohist$.

#### Packages

For this analysis we will be using several R packages.

```{r}
library(dendrohist)
library(rnaturalearth)
library(rnaturalearthhires)
library(ggplot2)
library(sf)
```

<br>

### How to retrieve CEDEX data

Time series can be retrieved as spatial $sf$ objects with function $read\_cedex\_basin.R$.

Different data sets can be selected by setting the $\bf{table}$ parameter:

* $\bf{table = "estaf"}$: some general information about the basin and the exact coordinates of gauging stations;
* $\bf{table = "afliq"}$: daily data from the gauging stations along the river;
* $\bf{table = "mensual\_a"}$: monthly data from the gauging stations along the river.

Further options will be implemented in the future.

Stations can be selected one by one or several at a time. For example, we may retrieve data for the Duero and Ebro basins as follows:

```{r}
z <- read_cedex_basin(table = "afliq", basin = c("duero", "ebro"), cs = "wgs84", verbose = F)
```

<br>

The resulting output lists the daily data for the Duero and Ebro stations as a spatial "sf" object. There are 10 basins to choose from, which can be introduced as a character vector. However, to retrieve all gauging stations at once we can set $basin = "all"$, which is also its default value.


show all stations in Spanish rivers on a map we just have to select all 10 basins. That is easily done by setting $basin = "all"$ or by saying nothing, since it is the default value.




```{r}
z <- read_cedex_basin(cs = "wgs84", verbose = F)
m <- ne_countries(scale = 10, country = "spain")
ggplot() + 
  geom_sf(data = m, aes(), color="white", fill="#7f7f7f", alpha=1/4) +
  geom_sf(data = z, aes(color = Cuenca)) +
  xlim(-10, 4) + ylim(36, 44)
```


There are stations outside the Spanish national limits.

```{r}

p <- st_filter(z, m)
i <- which(!(z$indroea %in% p$indroea))
p_out <- z[i, ]
ggplot() + 
  geom_sf(data = m, aes(), color="white", fill="#7f7f7f", alpha=1/4) +
  geom_sf(data = p_out, aes(color = cuenca)) +
  geom_sf_text(data = p_out, aes(label = lugar, angle = 90)) +
  xlim(-10, 4) + ylim(36, 44)
```

Although most of those locations are so close to the border that could be considered a good match nevertheless, there are two stations (9159 and 9204, named "Huarte" and "Matauco" respectively) that are located well into France but that should not be there.

```{r}
z_out <- z[which(z$lugar %in% c("HUARTE", "MATAUCO")), ]
```

Strange names since they are in Catalonia! Let me check their UTM coordinates.

```{r}
pp <- list('utm30' = read_cedex_basin(cs = "utm30", verbose = T),
           'etrs89' = read_cedex_basin(cs = "etrs89", verbose = T),
           'wgs84' = read_cedex_basin(cs = "wgs84", verbose = T),
           'ed50' = read_cedex_basin(cs = "ed50", verbose = T))
dxy <- matrix(NA, 4, 4)
for (i in 1:4) {
  for (j in 1:4) {
    p2 <- st_transform(pp[[i]], st_crs(pp[[j]]))
    plot(diag(st_distance(pp[[j]], p2)), main = c(i,j))
    dxy[i, j] <- max(diag(st_distance(pp[[j]], p2)))
  }
}
```

